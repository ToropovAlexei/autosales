# Платформа для E-commerce с Telegram-ботом

Это комплексное приложение, представляющее собой платформу для электронной коммерции. Она включает в себя бэкенд на FastAPI, фронтенд для администрирования на Next.js и Telegram-бота на aiogram для взаимодействия с клиентами.

## Возможности

- **Административная панель:** Удобный веб-интерфейс для продавцов для управления категориями, товарами, складом, заказами и транзакциями.
- **Telegram-бот для клиентов:** Позволяет пользователям просматривать каталог товаров, пополнять баланс и совершать покупки прямо в Telegram.
- **Реферальная программа:** Продавцы могут включить реферальную программу, позволяя пользователям создавать собственные "магазины-боты" и получать процент с продаж.
- **Система высокой доступности:** Основной Telegram-бот находится под управлением монитора, который отслеживает его состояние. В случае сбоя, монитор автоматически запускает резервного бота и может создать нового при необходимости, обеспечивая бесперебойную работу.

## Предварительные требования

Перед началом убедитесь, что у вас установлено следующее:

- Python 3.8+
- Node.js 18.x+
- pnpm (или npm/yarn)
- Docker и Docker Compose

## Базы данных

Для локальной разработки используются PostgreSQL и Redis, которые можно запустить с помощью Docker Compose.

1.  **Запустите контейнеры:**
    В корневой папке проекта выполните команду:
    ```bash
    docker-compose up -d
    ```
    Эта команда запустит PostgreSQL и Redis в фоновом режиме.

## Установка и запуск

Этот проект разделен на три основных компонента: `backend`, `frontend` и `tgbot`. Следуйте приведенным ниже инструкциям для настройки каждой части.

### Бэкенд

Бэкенд представляет собой приложение FastAPI, которое служит API для фронтенда и Telegram-бота.

1.  **Перейдите в каталог бэкенда:**

    ```bash
    cd backend
    ```

2.  **Создайте файл .env:**
    Создайте файл `.env` в каталоге `backend`, скопировав содержимое из `.env.example`, и заполните его необходимыми данными.

3.  **Создайте и активируйте виртуальное окружение:**

    ```bash
    python -m venv .venv
    source .venv/bin/activate
    ```

4.  **Установите зависимости:**

    ```bash
    pip install -r requirements.txt
    ```

5.  **Инициализируйте и заполните базу данных:**

    ```bash
    python init_db.py
    python seed_db.py # Опционально, для заполнения тестовыми данными
    ```

6.  **Запустите сервер бэкенда:**
    ```bash
    uvicorn main:app --reload
    ```
    Бэкенд будет запущен по адресу `http://127.0.0.1:8000`.

### Фронтенд

Фронтенд представляет собой приложение Next.js, которое предоставляет административную панель.

1.  **Перейдите в каталог фронтенда:**

    ```bash
    cd frontend
    ```

2.  **Установите зависимости:**

    ```bash
    pnpm install
    ```

3.  **Запустите сервер для разработки:**
    ```bash
    pnpm run dev
    ```
    Фронтенд будет запущен по адресу `http://localhost:3000`.

### Telegram-бот

Telegram-бот создан с использованием `aiogram` и обеспечивает взаимодействие с клиентами.

#### Ключевые концепции

Для правильной настройки и понимания работы бота, важно ознакомиться с несколькими понятиями:

- **Основной и Резервный боты:** Система спроектирована для высокой надежности. Для этого используются как минимум два бота: **основной** (активный), с которым общаются пользователи, и **резервный** (запасной). Специальный скрипт `monitor.py` постоянно следит за здоровьем основного бота. Если тот перестает отвечать, монитор немедленно делает резервного бота основным, обеспечивая непрерывность сервиса.

- **Автоматическое создание ботов (`API_ID` и `API_HASH`):** Чтобы система могла сама себя восстанавливать, ей нужны права на создание новых ботов от вашего имени. Для этого используются `API_ID` и `API_HASH` — это ваши личные ключи разработчика в Telegram.
  - **Что это?** Это не токен бота, а учетные данные вашего личного аккаунта. Они позволяют скрипту `monitor.py` подключаться к Telegram как вы и выполнять действия, например, общаться с `BotFather` для создания нового бота, если количество рабочих ботов упадет ниже двух.
  - **Где их взять?** Вы можете получить их на официальном сайте [my.telegram.org](https://my.telegram.org), войдя в свой аккаунт и перейдя в раздел "API development tools".

#### Настройка и запуск

1.  **Создайте ботов:**

    - Откройте Telegram и найдите официального бота `BotFather`.
    - Создайте как минимум двух ботов с помощью команды `/newbot`.
    - Сохраните токены обоих ботов. Токен выглядит примерно так: `1234567890:ABC-DEF1234ghIkl-zyx57W2v1u1234567890`.

2.  **Перейдите в каталог `tgbot`:**

    ```bash
    cd tgbot
    ```

3.  **Заполните `tokens.txt`:**

    - Создайте файл `tokens.txt`.
    - Вставьте в него токены двух созданных вами ботов, каждый с новой строки. Монитор будет использовать этот список для работы.

4.  **Заполните файл `.env`:**

    - Скопируйте `.env.example` в новый файл `.env`.
    - Вставьте ваш `API_ID` и `API_HASH`, полученные на [my.telegram.org](https://my.telegram.org).
    - Заполните остальные переменные, такие как `SERVICE_TOKEN` (для связи с бэкендом) и настройки Redis.
    - **Важно:** `BOT_TOKEN` в этом файле будет перезаписан монитором, но его можно оставить для тестов.

5.  **Создайте и активируйте виртуальное окружение:**

    ```bash
    python -m venv .venv
    source .venv/bin/activate
    ```

6.  **Установите зависимости:**

    ```bash
    pip install -r requirements.txt
    ```

7.  **Запустите монитор бота:**
    ```bash
    python monitor.py
    ```
    Монитор запустит основного бота из вашего списка, назначит резервного и будет поддерживать их в рабочем состоянии. Если один из ботов "умрет", монитор автоматически поднимет резервный и, если нужно, создаст новый с помощью ваших `API_ID` и `API_HASH`.

## Конфигурация

- **Бэкенд:** `backend/config.py` и `.env` файл. Здесь настраиваются подключение к базе данных, секретные ключи и другие параметры API.
- **Фронтенд:** `frontend/src/constants/endpoints.ts` для URL-адресов API. Основные настройки Next.js находятся в `next.config.ts`.
- **Telegram-бот:** `tgbot/config.py` и `.env` файл для токенов, `API_ID`, `API_HASH` и других настроек.
- **Монитор:** `tgbot/monitor.py` содержит логику для системы высокой доступности. Основные параметры (например, интервал проверки) можно настроить вверху файла.
